<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="icon" href="../_static/favicon.ico">
    <title>Sanic Support - GINO 1.0.0a0 documentation</title>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async
            src="https://www.googletagmanager.com/gtag/js?id=UA-3759436-10"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag () {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'UA-3759436-10');
    </script>
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css">
    <link type="text/css" rel="stylesheet"
          href="../_static/css/materialize.min.css"
          media="screen,projection"/>
    <link rel="stylesheet" href="../_static/pygments.css"
          type="text/css"/>
    <link type="text/css" rel="stylesheet"
          href="../_static/css/gino.css"/>
</head>
<body>

<header>
    <div class="navbar-fixed">
        <nav>
            <div class="nav-wrapper">
                <a href="../index.html" class="brand-logo">
                    <div class="img"
                         style="background-image: url(../_static/logo.png); width: 40px; height: 40px; margin-right: 8px"></div>
                    <div class="img"
                         style="background-image: url(../_static/logo-name.png); width: 100px; height: 32.5px; margin-top: 4px"></div>
                </a>
                <div class="breadcrumbs">
                    <a class="breadcrumb" style="display: none"></a>
                    
                        <a href="../how-to.html"
                           class="breadcrumb">How-to Guides</a>
                    
                    
                        <a class="breadcrumb" style="color: #FFFFFF">Sanic Support</a>
                    
                </div>
                <div class="spacer"></div>
                <div class="search">
                    <input type="text" id="search" placeholder="Search">
                    <i class="mdi mdi-magnify"></i>
                </div>
                <a class="waves-effect waves-light btn-flat theme-dark" href="/">
                    <i class="mdi mdi-home"></i>
                    Home
                </a>
                <a class="waves-effect waves-light btn-flat theme-dark"
                   href="/authors.html">
                    <i class="mdi mdi-account-group"></i>
                    Authors
                </a>
                <a href="https://github.com/python-gino/gino" target="_blank"
                   class="github">
                    <i class="mdi mdi-github-circle"></i>
                </a>
            </div>
        </nav>
    </div>

    <div id="sidenav" class="sidenav sidenav-fixed">
        <p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorial.html">Tutorial</a></li>
</ul>
<p class="caption"><span class="caption-text">How-to Guides</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../how-to.html">How-to Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="crud.html">CRUD</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="loaders.html">Loaders and Relationship</a></li>
<li class="toctree-l1"><a class="reference internal" href="pool.html">Connection Pool</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Sanic Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="schema.html">Schema Declaration</a></li>
<li class="toctree-l1"><a class="reference internal" href="tornado.html">Tornado Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="transaction.html">Transaction</a></li>
</ul>
<p class="caption"><span class="caption-text">Explanation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../explanation.html">Explanation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanation/engine.html">Engine and Connection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanation/why.html">Why Asynchronous ORM?</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/history.html">History</a></li>
</ul>

    </div>
</header>

<main>
    <div class="row">
        <div class="col s12 m9 body">
            
    <div class="section" id="sanic-support">
<h1>Sanic Support<a class="headerlink" href="#sanic-support" title="Permalink to this headline">¶</a></h1>
<p><strong>THIS IS A WIP</strong></p>
<div class="section" id="work-with-sanic">
<h2>Work with Sanic<a class="headerlink" href="#work-with-sanic" title="Permalink to this headline">¶</a></h2>
<p>Using the Sanic extension, the request handler acquires a lazy connection on each request,
and return the connection when the response finishes by default.</p>
<p>The lazy connection is actually established if necessary, i.e. just before first access to db.</p>
<p>This behavior is controlled by app.config.DB_USE_CONNECTION_FOR_REQUEST, which is True by default.</p>
<p>Supported configurations:</p>
<ul class="simple">
<li><p>DB_HOST</p></li>
<li><p>DB_PORT</p></li>
<li><p>DB_USER</p></li>
<li><p>DB_PASSWORD</p></li>
<li><p>DB_DATABASE</p></li>
<li><p>DB_ECHO</p></li>
<li><p>DB_POOL_MIN_SIZE</p></li>
<li><p>DB_POOL_MAX_SIZE</p></li>
<li><p>DB_USE_CONNECTION_FOR_REQUEST</p></li>
<li><p>DB_KWARGS</p></li>
</ul>
<p>An example server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sanic</span> <span class="kn">import</span> <span class="n">Sanic</span>
<span class="kn">from</span> <span class="nn">sanic.exceptions</span> <span class="kn">import</span> <span class="n">abort</span>
<span class="kn">from</span> <span class="nn">sanic.response</span> <span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="nn">gino.ext.sanic</span> <span class="kn">import</span> <span class="n">Gino</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Sanic</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">DB_HOST</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">DB_DATABASE</span> <span class="o">=</span> <span class="s1">&#39;gino&#39;</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">Gino</span><span class="p">()</span>
<span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;users&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">BigInteger</span><span class="p">(),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">nickname</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&lt;</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nickname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/users/&lt;user_id&gt;&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;invalid user id&#39;</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">User</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">json</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">nickname</span><span class="p">})</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h2>Sanic Support<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>To integrate with Sanic, a few configurations needs to be set in
<code class="docutils literal notranslate"><span class="pre">app.config</span></code> (with default value though):</p>
<ul class="simple">
<li><p>DB_HOST: if not set, <code class="docutils literal notranslate"><span class="pre">localhost</span></code></p></li>
<li><p>DB_PORT: if not set, <code class="docutils literal notranslate"><span class="pre">5432</span></code></p></li>
<li><p>DB_USER: if not set, <code class="docutils literal notranslate"><span class="pre">postgres</span></code></p></li>
<li><p>DB_PASSWORD: if not set, empty string</p></li>
<li><p>DB_DATABASE: if not set, <code class="docutils literal notranslate"><span class="pre">postgres</span></code></p></li>
<li><p>DB_ECHO: if not set, <code class="docutils literal notranslate"><span class="pre">False</span></code></p></li>
<li><p>DB_POOL_MIN_SIZE: if not set, 5</p></li>
<li><p>DB_POOL_MAX_SIZE: if not set, 10</p></li>
<li><p>DB_KWARGS; if not set, empty dictionary</p></li>
</ul>
<p>An example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sanic</span> <span class="kn">import</span> <span class="n">Sanic</span>
<span class="kn">from</span> <span class="nn">gino.ext.sanic</span> <span class="kn">import</span> <span class="n">Gino</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Sanic</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">DB_HOST</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">DB_USER</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">Gino</span><span class="p">()</span>
<span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
</div>
<p>After <code class="docutils literal notranslate"><span class="pre">db.init_app</span></code>, a connection pool with configured settings shall be
created and bound to <code class="docutils literal notranslate"><span class="pre">db</span></code> when Sanic server is started, and closed on stop.
Furthermore, a lazy connection context is created on each request, and released
on response. That is to say, within Sanic request handlers, you can directly
access db by e.g. <code class="docutils literal notranslate"><span class="pre">User.get(1)</span></code>, everything else is settled: database pool is
created on server start, connection is lazily borrowed from pool on the first
database access and shared within the rest of the same request handler, and
automatically returned to the pool on response.</p>
<p>Please be noted that, in the async world, <code class="docutils literal notranslate"><span class="pre">await</span></code> may block unpredictably for
a long time. When this world is crossing RDBMS pools and transactions, it is
a very dangerous bite for performance, even causing disasters sometimes.
Therefore we recommend, during the time enjoying fast development, do pay
special attention to the scope of transactions and borrowed connections, make
sure that transactions are closed as soon as possible, and connections are not
taken for unnecessarily long time. As for the Sanic support, if you want to
release the concrete connection in the request context before response is
reached, just do it like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">await</span> <span class="n">request</span><span class="p">[</span><span class="s1">&#39;connection&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</pre></div>
</div>
<p>Or if you prefer not to use the contextual lazy connection in certain handlers,
prefer explicitly manage the connection lifetime, you can always borrow a new
connection by setting <code class="docutils literal notranslate"><span class="pre">reuse=False</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">reuse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># new connection context is created</span>
</pre></div>
</div>
<p>Or if you prefer not to use the builtin request-scoped lazy connection at all,
you can simply turn it off:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">DB_USE_CONNECTION_FOR_REQUEST</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>


        </div>

        <div class="col hide-on-small-only m3 right-nav">
            <div class="table-of-contents fixed">
                
                    <ul>
<li><a class="reference internal" href="#">Sanic Support</a><ul>
<li><a class="reference internal" href="#work-with-sanic">Work with Sanic</a></li>
<li><a class="reference internal" href="#id1">Sanic Support</a></li>
</ul>
</li>
</ul>

                
            </div>
        </div>

    </div>
    <div class="fixed-action-btn click-to-toggle">
        <a class="btn-floating btn-large blue">
            <i class="mdi mdi-translate"></i>
        </a>
        <ul>
            <li><a href="/docs/en/master" class="btn-floating blue">EN</a></li>
            <li><a href="/docs/zh/master" class="btn-floating red">ZH</a></li>
        </ul>
    </div>
</main>

<script type="text/javascript"
        src="../_static/js/materialize.min.js"></script>
<script type="text/javascript"
        src="../_static/js/gino.js"></script>
</body>
</html>