<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="icon" href="../_static/favicon.ico">
    <title>异步编程基础 - GINO 1.1.0b2 文档</title>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async
            src="https://www.googletagmanager.com/gtag/js?id=UA-3759436-10"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag () {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'UA-3759436-10');
    </script>
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Raleway:400,500,600,700&display=swap">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css">
    <link type="text/css" rel="stylesheet"
          href="../_static/css/materialize.min.css"
          media="screen,projection"/>
    <link rel="stylesheet" href="../_static/pygments.css"
          type="text/css"/>
    <link type="text/css" rel="stylesheet"
          href="../_static/css/gino.css"/>
</head>
<body>

<header>
    <div class="navbar-fixed">
        <nav>
            <div class="nav-wrapper">
                <a href="#" data-target="sidenav" class="sidenav-trigger"><hr><hr><hr></a>
                <a href="../index.html" class="brand-logo">
                    <div class="img"
                         style="background-image: url(../_static/logo.svg); width: 103px; height: 40px;"></div>
                </a>
                <div class="breadcrumbs">
                    <a class="breadcrumb" style="display: none"></a>
                    
                        <a href="../explanation.html"
                           class="breadcrumb">原理说明</a>
                    
                    
                        <a class="breadcrumb" style="color: #FFFFFF">异步编程基础</a>
                    
                </div>
                <div class="spacer"></div>
                <div id="search-container" class="search">
                    <input type="text" id="search" placeholder="搜索">
                    <i class="mdi mdi-magnify"></i>
                    <div id="search-results" style="display: none"></div>
                </div>
                <a class="btn-flat theme-dark" href="/">
                    首页
                </a>
                <a class="btn-flat theme-dark" href="/authors.html">
                    鸣谢
                </a>
                <a href="https://github.com/python-gino/gino" target="_blank"
                   class="github-stars">
                    <div class="left"><img
                        src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iNDNweCIgaGVpZ2h0PSI0MnB4IiB2aWV3Qm94PSIwIDAgNDMgNDIiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDYxLjIgKDg5NjUzKSAtIGh0dHBzOi8vc2tldGNoLmNvbSAtLT4KICAgIDx0aXRsZT5GaWxsIDQ5PC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGcgaWQ9IlYzLeacgOaWsOeov+S7tiIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPGcgaWQ9IkhPTUUtdjMiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0xNTA3LjAwMDAwMCwgLTQ5LjAwMDAwMCkiIGZpbGw9IiNGRkZGRkUiPgogICAgICAgICAgICA8ZyBpZD0iYmFubmVyLWJnIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMzc5LjAwMDAwMCwgLTE4Ny4wMDAwMDApIj4KICAgICAgICAgICAgICAgIDxnIGlkPSJoZWFkZXIiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDU5Ny4wMDAwMDAsIDIxOC4wMDAwMDApIj4KICAgICAgICAgICAgICAgICAgICA8cGF0aCBkPSJNMTMxMC40OTgwMiwxOCBDMTI5OC42MjcxMiwxOCAxMjg5LDI3LjYzOTg4MzEgMTI4OSwzOS41MzIxMTIzIEMxMjg5LDQ5LjA0NTEwMjYgMTI5NS4xNTk4Myw1Ny4xMTQ2ODggMTMwMy43MDMzNCw1OS45NjE4NDM5IEMxMzA0Ljc3OTAzLDYwLjE2MDExMzggMTMwNS4xNzEwMyw1OS40OTUyNDg3IDEzMDUuMTcxMDMsNTguOTI0MjMxMyBDMTMwNS4xNzEwMyw1OC40MTI2OTUgMTMwNS4xNTI1NSw1Ny4wNTkxNzI0IDEzMDUuMTQxOTksNTUuMjYyODQ3IEMxMjk5LjE2MTY3LDU2LjU2MzQ5NzYgMTI5Ny44OTk4Nyw1Mi4zNzYwMzcxIDEyOTcuODk5ODcsNTIuMzc2MDM3MSBDMTI5Ni45MjE4NSw0OS44ODg0MTA2IDEyOTUuNTEyMjMsNDkuMjI2MTg5MSAxMjk1LjUxMjIzLDQ5LjIyNjE4OTEgQzEyOTMuNTYwMTUsNDcuODkxMTcxNyAxMjk1LjY2MDA2LDQ3LjkxNzYwNzcgMTI5NS42NjAwNiw0Ny45MTc2MDc3IEMxMjk3LjgxODA0LDQ4LjA2OTYxNDYgMTI5OC45NTMxMyw1MC4xMzY5MDg5IDEyOTguOTUzMTMsNTAuMTM2OTA4OSBDMTMwMC44NzA5LDUzLjQyNjg2NzYgMTMwMy45ODU3OSw1Mi40NzY0OTM4IDEzMDUuMjEwNjMsNTEuOTI1MzAzNSBDMTMwNS40MDU5Nyw1MC41MzQ3NzA1IDEzMDUuOTYxNjMsNDkuNTg1NzE4NiAxMzA2LjU3NTM3LDQ5LjA0Nzc0NjIgQzEzMDEuODAxNDEsNDguNTA0NDg2NiAxMjk2Ljc4MTk1LDQ2LjY1NjYxMTEgMTI5Ni43ODE5NSwzOC40MDU5MzkyIEMxMjk2Ljc4MTk1LDM2LjA1NTc3OTkgMTI5Ny42MjAwNiwzNC4xMzI1NjE3IDEyOTguOTk1MzcsMzIuNjI4MzU0IEMxMjk4Ljc3MzYzLDMyLjA4Mzc3MjYgMTI5OC4wMzU4MiwyOS44OTM1NTEgMTI5OS4yMDY1NCwyNi45MzAwNzY4IEMxMjk5LjIwNjU0LDI2LjkzMDA3NjggMTMwMS4wMTA4LDI2LjM1MTEyODYgMTMwNS4xMTgyNCwyOS4xMzc0ODE4IEMxMzA2LjgzMjc1LDI4LjY1ODk5MDQgMTMwOC42NzI2NCwyOC40MjEwNjY1IDEzMTAuNTAwNjYsMjguNDExODEzOSBDMTMxMi4zMjczNiwyOC40MjEwNjY1IDEzMTQuMTY1OTQsMjguNjU4OTkwNCAxMzE1Ljg4MzA4LDI5LjEzNzQ4MTggQzEzMTkuOTg3ODgsMjYuMzUxMTI4NiAxMzIxLjc4OTUsMjYuOTMwMDc2OCAxMzIxLjc4OTUsMjYuOTMwMDc2OCBDMTMyMi45NjI4NiwyOS44OTM1NTEgMTMyMi4yMjUwNSwzMi4wODM3NzI2IDEzMjIuMDA0NjMsMzIuNjI4MzU0IEMxMzIzLjM4MjU4LDM0LjEzMjU2MTcgMTMyNC4yMTQwOSwzNi4wNTU3Nzk5IDEzMjQuMjE0MDksMzguNDA1OTM5MiBDMTMyNC4yMTQwOSw0Ni42Nzc3NTk5IDEzMTkuMTg2NzIsNDguNDk3ODc3NiAxMzE0LjM5ODIzLDQ5LjAzMDU2MjggQzEzMTUuMTY5MDQsNDkuNjk1NDI3OSAxMzE1Ljg1NjY5LDUxLjAwOTI5NjUgMTMxNS44NTY2OSw1My4wMTcxMDk4IEMxMzE1Ljg1NjY5LDU1Ljg5NTk4ODkgMTMxNS44MzAyOSw1OC4yMTgzOTA1IDEzMTUuODMwMjksNTguOTI0MjMxMyBDMTMxNS44MzAyOSw1OS41MDA1MzU5IDEzMTYuMjE4MzMsNjAuMTcwNjg4MiAxMzE3LjMwODU0LDU5Ljk2MDUyMjEgQzEzMjUuODQ1NDUsNTcuMTA2NzU3MiAxMzMyLDQ5LjA0MjQ1OSAxMzMyLDM5LjUzMjExMjMgQzEzMzIsMjcuNjM5ODgzMSAxMzIyLjM3Mjg4LDE4IDEzMTAuNDk4MDIsMTgiIGlkPSJGaWxsLTQ5Ij48L3BhdGg+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgIDwvZz4KICAgICAgICA8L2c+CiAgICA8L2c+Cjwvc3ZnPg=="
                        class="github-logo">
                        GitHub
                    </div>
                    <div class="right"><img
                        src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMjFweCIgaGVpZ2h0PSIxOXB4IiB2aWV3Qm94PSIwIDAgMjEgMTkiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDYxLjIgKDg5NjUzKSAtIGh0dHBzOi8vc2tldGNoLmNvbSAtLT4KICAgIDx0aXRsZT5QYXRoPC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGcgaWQ9IlYzLeacgOaWsOeov+S7tiIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPGcgaWQ9IkhPTUUtdjMiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0xNTYxLjAwMDAwMCwgLTYwLjAwMDAwMCkiIGZpbGw9IiNGOEQyMzAiPgogICAgICAgICAgICA8ZyBpZD0iYmFubmVyLWJnIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMzc5LjAwMDAwMCwgLTE4Ny4wMDAwMDApIj4KICAgICAgICAgICAgICAgIDxnIGlkPSJoZWFkZXIiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDU5Ny4wMDAwMDAsIDIxOC4wMDAwMDApIj4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0ibGFiZWwtY29weS0xMiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTI4OS4wMDAwMDAsIDE4LjAwMDAwMCkiPgogICAgICAgICAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aCIgcG9pbnRzPSI2MS4wNTQzNTQzIDE3Ljc1NzM4MzYgNTQuMjE1MjQ2NiAxOC4zMTMzOTI5IDU5Ljg4OTM1MTcgMjIuOTczNzM4NyA1Ny43ODQ1MjI4IDI5Ljg0MDExODQgNjQuNDQyNTI3MSAyNi41NDM0MTg4IDcwLjU3NzcyMzkgMjkuODQwMTE4NCA2OS4yMzA0MzI1IDIyLjk3MzczODcgNzQuNzMyNTY5NiAxOC4zMTMzOTI5IDY3Ljg5MzQ2MiAxNy43NTczODM2IDY0LjQ0MjUyNzEgMTEuMzc1Ij48L3BvbHlnb24+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8L2c+CiAgICAgICAgPC9nPgogICAgPC9nPgo8L3N2Zz4=">
                        <span id="github-star-num"></span>
                    </div>
                </a>
            </div>
        </nav>
    </div>

    <div id="sidenav" class="sidenav sidenav-fixed">
        <p class="caption" role="heading"><span class="caption-text">上手教程</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials.html">上手教程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/announcement.html">官宣：Python 异步编程再添一利器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorial.html">GINO 基础教程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/fastapi.html">搭建一个 FastAPI 服务器</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">进阶用法</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../how-to.html">进阶用法</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/alembic.html">使用 Alembic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/bakery.html">预制查询</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/contributing.html">贡献</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/crud.html">增删改查</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/faq.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/json-props.html">JSON 扩展属性</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/loaders.html">加载器与关系</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/pool.html">连接池</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/schema.html">表结构定义</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/transaction.html">数据库事务</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">原理说明</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../explanation.html">原理说明</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">异步编程基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="engine.html">引擎与连接</a></li>
<li class="toctree-l1"><a class="reference internal" href="sa20.html">SQLAlchemy 2.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="why.html">为什么要用异步 ORM？</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">参考手册</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference.html">参考手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/api.html">API 参考</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/extensions.html">扩展</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/history.html">版本历史</a></li>
</ul>

    </div>
</header>

<main>
    <div class="row">
        <div class="col s12 m9 body">
            <div id="main-content" role="main">
                
    <section id="asynchronous-programming-101">
<h1>异步编程基础<a class="headerlink" href="#asynchronous-programming-101" title="永久链接至标题">¶</a></h1>
<section id="the-story">
<h2>一个经典场景<a class="headerlink" href="#the-story" title="永久链接至标题">¶</a></h2>
<p>假如现在我们想要去创建自己的搜索引擎，为了创建索引数据库，家境贫寒的我们使用了一台单核电脑去爬取网页（I/O型操作），然后再将这些网页内容进行处理（计算型操作）。这个过程如下图所示：</p>
<img alt="../_images/why_single_task.png" class="align-center" src="../_images/why_single_task.png" />
<p>由于我们有很多网页去要去进行爬取和处理，所以我们只能将上面的过程一个个顺序执行：</p>
<img alt="../_images/why_throughput.png" class="align-center" src="../_images/why_throughput.png" />
<p>假设每个过程耗时一样，每 1 秒可以进行 2 次这样的处理，那么我可以称我们这台单核的机器的吞吐量为 2 任务/秒。如何提升当前系统的吞吐量？一个比较简单的做法就是增加 CPU 的核心数量：</p>
<img alt="../_images/why_multicore.png" class="align-center" src="../_images/why_multicore.png" />
<p>如上图所示，我们超级加倍了 CPU 资源后，在未达到网络瓶颈的情况下，吞吐量也轻松翻倍，达到了 4 任务/秒。但是，我们还可以针对单个 CPU 核心增加吞吐量吗？当然可以，使用多线程：</p>
<img alt="../_images/why_multithreading.png" class="align-center" src="../_images/why_multithreading.png" />
<p>桥多麻袋！即便是有用了 2 个线程，我们的单核机器在 2 秒内勉勉强强才完成了 6 个任务，吞吐量也只有 2.7 任务/秒，远比 2 核心机器的 4 任务/秒的吞吐量少诶，所以所线程有啥问题呢？一起康康上面的图：</p>
<ul class="simple">
<li><p>图片上黄色色块代表额外的时间开销（啥是额外时间？马上就会提到）</p></li>
<li><p>绿绿的色块（代表爬取网页任务）在上图所示的两个线程上可以重叠，代表可以被多个线程一起执行，但是</p></li>
<li><p>非绿色的色块却不能彼此重叠，即不能被多线程同时一起执行。</p></li>
</ul>
<p>黄色色块代表被<a class="reference external" href="https://en.wikipedia.org/wiki/Context_switch">上下文切换</a>所消耗的时间，简单理解，就是在单核 CPU 并发处理时在多个线程中切换所消耗的时间。单核 CPU 只能在同一时间处理一件事（假设这个世界上类似<a class="reference external" href="https://en.wikipedia.org/wiki/Hyper-threading">超线程</a>技术还没有被发明出来），所以为了在单核 CPU 上同时处理多线程，CPU 必须将<a class="reference external" href="https://en.wikipedia.org/wiki/Time-sharing">自己的时间</a>分成片，并且在这些被分好的时间片内处理一点点当前线程的任务，然后在下一个时间片切换到其他线程继续处理。所以刚才所说的黄色色块所消耗的额外时间实际上就是在这些线程直接来回切换所消耗的时间。虽然上图的黄色色块看上去好像占了好大一块，但实际上没这么夸张，这里是为了方便理解故意搞了个大新闻。</p>
<p>桥多麻袋！！还没完！既然绿色的色块可以在多线程图上重合，是不是代表这 CPU 同时处理了爬取网页的操作呢？答案是 NO！在绿色的色块覆盖的时间内，CPU 没有处理任何事情，这是因为它正在等待 HTTP 的响应（I/O 操作）。这也是使用了多线程后吞吐量还是提高到了 2.7 任务/秒，而不是降低到 1.7 任务/秒的原因。你可能会想尝试用单核 CPU 搞个多线程去处理计算密集型的任务，但这肯定没有任何提高，甚至会适合其反，正如上图所示的红色色块一样（代表处理爬取到信息的任务；实际中的上下文切换可能更加频繁一些），只能说这些任务看上去好像是同时在运行一样，但是这些任务交替执行所消耗的时间甚至比一个个的顺序执行所消耗的时间更多。这也就是为什么当前的事例中只能被称为并发，而不是并行。</p>
<p>你也许还会想，每多增加一个线程吞吐量可能还是会有所提升，直到因为上下文切换所消耗的时间过多而影响了系统的吞吐量，这里还没有算上每一个新的线程所占用的系统内存。通常我们不会在实际生产中在单核的 CPU 上去跑它个几百几千个线程。那么问题来了，有可能在单核 CPU 上并发处理数万个 I/O 密集型的任务吗？这就是著名的 <a class="reference external" href="https://en.wikipedia.org/wiki/C10k_problem">C10k 问题</a>，而解决这个问题的办法，正是异步 I/O：</p>
<img alt="../_images/why_coroutine.png" class="align-center" src="../_images/why_coroutine.png" />
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>需要注意的是，异步 I/O 和协程是两个概念，但是他们经常被一起提及。在这里，为了简单起见，我们将只讲协程。</p>
</div>
<p>看上去很奈斯嘛！现在的吞吐量是 3.7 任务/秒，已经快达到我们买不起的双核 CPU 机器的 4 任务/秒吞吐量了！虽然这些图都不是使用真是的数据，但是相比系统级别的线程而言，协程真的在上下文切换上开销更加少并且占用更少的内存，这也让协程成为解决 C10K 问题的理想选择，</p>
</section>
<section id="cooperative-multitasking">
<h2>协作式多任务处理<a class="headerlink" href="#cooperative-multitasking" title="永久链接至标题">¶</a></h2>
<p>说了半天，协程到底是什么？</p>
<p>在上一个图中，你可能已经注意到了它和之前一张图片不一样的地方：在同一条线程内，绿色的色块彼此重叠了。这正是因为我们在上图中使用了异步 I/O 编程，而之前的图片中我们使用的是阻塞式的 I/O 编程。顾名思义，阻塞式的 I/O 编程会在代码执行到进行 I/O 操作时等待 I/O 结果返回，从而阻塞当前线程。因此，每条线程中同时只可能执行一个阻塞式的 I/O 操作。为了能够在阻塞式的 I/O 编程中达到并发，要么使用多线程，要么就使用多进程。对比之下，异步 I/O 允许在一条线程中同时进行数千（甚至更多）次 I/O 并发操作，此时在同一线程内，每一次的 I/O 操作只会阻塞当前协程而不是整个线程。和多线程一样，协程可以完成 I/O 的并发，但它仅仅只发生在一条线程内。</p>
<p>在操作系统中，线程是以<a class="reference external" href="https://en.wikipedia.org/wiki/Preemption_(computing)">抢占式多任务处理</a>的方式进行的。举个栗子，还记得我们之前的图表吗，我们只有一个 CPU 核心，当两个线程准备处理各自爬取到的第一个网页的内容，此时第一个线程先执行，但是还没等线程一执行完毕，操作系统就打断了线程一转而去执行线程二，但是线程一的活还没干完啊，所以还要等到系统挂起线程二重新再执行线程一。如果线程内需要处理的工作很复杂的话，这里面的切换次数那就多了。但也正因为有这样的切换，每个线程才有可能去执行它当前的内容。请阅读下文，并回答文中使用了哪一种修辞手法：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Thread 1: I wanna run!
OS: Okay, here you go...
Thread 2: I wanna run!
OS: Urh, alright one sec ... Thread 1, hold on for a while!
Thread 1: Well I&#39;m not done yet, but you are the boss.
OS: It won&#39;t be long. Thread 2 it&#39;s your turn now.
Thread 2: Yay! (&amp;%#$@..+*&amp;#)
Thread 1: Can I run now?
OS: Just a moment please ... Thread 2, give it a break!
Thread 2: Alright ... but I really need the CPU.
OS: You&#39;ll have it later. Thread 1, hurry up!
</pre></div>
</div>
<p>而协程，恰恰相反，它是在某个事件管家的帮助下合作完成任务的。这个事件管家同样也和协程在同一条线程内。但是和通过系统调度完成强制切换的线程不一样，事件管家只会在协程自我挂起的时候完成协程的切换。上面说了线程是抢占式地多任务，因此它是只要自己不阻塞了就想被运行，但是协程相对佛系，一切由事件管家调度，来决定哪一条协程可以被运行。当一条执行中的协程突然遇到一个需要等待的事件（比如HTTP响应），它会将控制权交换给事件管家然后默默等待事件完成，此时事件管家就去找去找另外一条已经得到事件响应的协程，然后将控制权交给它，让它执行。这种并发模式被称为<a href="#id2"><span class="problematic" id="id3">`协作式多任务处理&lt;https://en.wikipedia.org/wiki/Cooperative_multitasking&gt;`_</span></a>，如果换成拟人的修辞手法，他们大概是这样交流的：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Coroutine 1: Let me know when event A arrives. I&#39;m done here before that.
Event manager: Okay. What about you, coroutine 2?
Coroutine 2: Um I&#39;ve got nothing to do here before event B.
Event manager: Cool, I&#39;ll be watching.
Event manager: (after a while) Hey coroutine 1, event A is here!
Coroutine 1: Awesome! Let me see ... looks good, but I need event C now.
Event manager: Very well. Seems event B arrived just now, coroutine 2?
Coroutine 2: Oh wonderful! Let me store it in a file ... There! I&#39;m all done.
Event manager: Sweet! Since there&#39;s no sign of event C yet, I&#39;ll sleep for a while.
(silence)
Event manager: Damn, event C timed out!
Coroutine 1: Arrrrh gotta kill myself with an exception :S
Event manager: Up to you :/
</pre></div>
</div>
<p>协程遇到IO事件将会等待并挂起自己当前的任务，但它不能被其他外部因素打断。所以当有很多协程的时候，并发就是由这些协程时不时地遇到事件时挂起来实现的。当然，如果你写了一个永远不会挂起的协程，它也不会允许任何并发的产生，因为其他的协程根本没有机会去运行。另外一方面，由于不会有多个协程同时运行，我们也大可不必我们所写的担心代码会搞乱一些共享的资源。现在你能理解上图中协程和线程红色色块堆叠方式不一样的原因了吧。</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>在Python中，<code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">def</span></code> 用来声明协程，<code class="docutils literal notranslate"><span class="pre">await</span></code> 用来将协程加入一个事件循环（即上文提到的将控制权交给事件管家）。</p>
</div>
</section>
<section id="pros-and-cons">
<h2>异步I/O的利弊<a class="headerlink" href="#pros-and-cons" title="永久链接至标题">¶</a></h2>
<p>异步I/O能够在同一条线程里面完成成千上万次的并发I/O操作。这样就能够节省多线程带来的CPU上下文切换时间以及内存。因此，在面临I/O密集型的任务时，异步I/O能够有效地使用CPU和内存资源，以达到相对较高的吞吐量。</p>
<p>并且，在Python中可以轻松自然地编写基于协程的代码。如果业务逻辑十分复杂，基于协程完成异步I/O的代码读起来也是行云流水。</p>
<p>但是，对于一个任务来说，异步I/O也会降低吞吐量。比如，调用函数 <code class="docutils literal notranslate"><span class="pre">recv()</span></code> ，它仅仅只是阻塞地等待返回值。而如果想要它变为异步，则必须要注册读事件，等待事件循环，尝试调用 <a href="#id1"><span class="problematic" id="id2">``</span></a>recv()``函数，重复以上步骤，直到结果真正返回，然后再进行回调。所以用了协程之后，整个框架的开销实际上更大了。不过幸好有了像uvloop这样优秀的事件管理模块，上述的开销已经被极大地减少。即使是这样，和阻塞式的I/O相比，总提上开销还是大了些。</p>
<p>想要去为异步I/O的程序计算耗时也是比较费劲的，由于协作的特性，程序的可预测性会变差。举个栗子，你可能希望当前的协程暂停1秒钟。但是此时如果另外一个协程得到了控制权，开始运行，结果计算太久，花费了2秒钟，当我们再次回到刚才的协程时，2秒钟已经实实在在地过了，这么来看，<code class="docutils literal notranslate"><span class="pre">sleep(1)</span></code> 这个操作已经不能理解为暂停1秒，而应该理解为至少暂停1秒。所以，你应该努力做到让那些不使用 <code class="docutils literal notranslate"><span class="pre">await</span></code> 进行调用、同步执行的代码尽可能快得执行，让协程真正得“合作”起来。但即使你真的做到了让同步代码快速执行，有时程序的运行候难免还是会不如你所愿，所以要时刻记住这种在执行时间上的不确定性，这样才能方便更好地排查问题。</p>
<p>最后，异步编程其实是复杂的。要真正写好异步的代码比想象中的难很多，而且异步的代码比同步的代码更加难以调试。尤其是当整个团队都在处理同一段异步代码时，常常会遇到意想不到的问题。因此，这里给一个比较中肯的建议：仅仅在I/O密集型的高并发场景中谨慎使用异步I/O。不是说使用了异步I/O就能够给并发性能带来的巨大提升，它更像一把双刃剑。而且如果要处理一些对时间要求十分严格的任务，请考虑再三！</p>
</section>
</section>


            </div>
            <p style="text-align: center; font-size: 12px;">
                <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
                    <img
                        alt="知识共享许可协议"
                        style="border-width:0"
                        src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
                    />
                </a>
                <br/>
                本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a>进行许可。
            </p>
        </div>

        <div class="col hide-on-small-only m3 right-nav">
            <div class="table-of-contents fixed">
                
                    <ul>
<li><a class="reference internal" href="#">异步编程基础</a><ul>
<li><a class="reference internal" href="#the-story">一个经典场景</a></li>
<li><a class="reference internal" href="#cooperative-multitasking">协作式多任务处理</a></li>
<li><a class="reference internal" href="#pros-and-cons">异步I/O的利弊</a></li>
</ul>
</li>
</ul>

                
                <div id="version-selector">
                    
                        <hr>
                    
                    
                        <div class="version-warning">
                            
                                您正在浏览 master 分支，该文档可能涉及尚未发布的功能。
                            
                        </div>
                    
                </div>
                <div class="add-your-lang">
                    <a href="https://www.transifex.com/decentfox-studio/gino_1_0/"
                       target="_blank">Add your language here.</a>
                </div>
            </div>
        </div>

    </div>
    <div class="fixed-action-btn click-to-toggle">
        <a class="btn-floating btn-large white">
            <img src="../_static/images/language.svg">
            <div>
              ZH
            </div>
        </a>
        <ul id="lang-selector">
        </ul>
    </div>
</main>

<script type="text/javascript" src="../_static/js/materialize.min.js"></script>
<script type="text/javascript" src="../_static/js/language_data.js"></script>
<script id="documentation_options" data-url_root="../" src="../_static/js/documentation_options.js"></script>
<script type="text/javascript" src="../_static/js/underscore.js"></script>
<script type="text/javascript" src="../_static/js/jquery.js"></script>
<script type="text/javascript">
    var sver = 'master';
    var language = 'zh';
    var pagename = 'explanation/async';
</script>
<script type="text/javascript" src="../_static/js/gino.js"></script>
<script type="text/javascript" src="../searchindex.js"></script>
</body>
</html>